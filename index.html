<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
<link rel="shortcut icon" href="favicon.ico">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no, user-scalable=no" />
<meta charset="UTF-8" />
<title>LibreSpeed - Internet Speed Test</title>
<script src="https://cdn.tailwindcss.com"></script>
<script>
    tailwind.config = {
        darkMode: 'class'
    }
</script>
<script type="text/javascript" src="speedtest.js"></script>
<script type="text/javascript">
function I(i){return document.getElementById(i);}

//LIST OF TEST SERVERS. Leave empty if you're doing a standalone installation. See documentation for details
var SPEEDTEST_SERVERS=[
	{	//this server doesn't actually exist, remove it
		name:"local", //user friendly name for the server
		server:"//192.168.2.195:9000", //URL to the server. // at the beginning will be replaced with http:// or https:// automatically
		dlURL:"backend/garbage.php",  //path to download test on this server (garbage.php or replacement)
		ulURL:"backend/empty.php",  //path to upload test on this server (empty.php or replacement)
		pingURL:"backend/empty.php",  //path to ping/jitter test on this server (empty.php or replacement)
		getIpURL:"backend/getIP.php"  //path to getIP on this server (getIP.php or replacement)
	},
	{	//this server doesn't actually exist, remove it
		name:"kamilszczepanski.com", //user friendly name for the server
		server:"//la.speedtest.clouvider.net/", //URL to the server. // at the beginning will be replaced with http:// or https:// automatically
		dlURL:"backend/garbage.php",  //path to download test on this server (garbage.php or replacement)
		ulURL:"backend/empty.php",  //path to upload test on this server (empty.php or replacement)
		pingURL:"backend/empty.php",  //path to ping/jitter test on this server (empty.php or replacement)
		getIpURL:"backend/getIP.php"  //path to getIP on this server (getIP.php or replacement)
	}
];

//INITIALIZE SPEEDTEST
var s=new Speedtest(); //create speed test object
s.setParameter("telemetry_level","basic"); //enable basic telemetry (for results sharing)

//SERVER AUTO SELECTION
function initServers(){
	// Initialize theme toggle first
	initThemeToggle();
	
	if(SPEEDTEST_SERVERS.length==0){ //standalone installation
		//just make the UI visible
		I("loading").style.display="none";
		I("serverArea").style.display="none";
		I("testWrapper").classList.remove("hidden");
		initUI();
	}else{ //multiple servers
		var noServersAvailable=function(){
			I("message").innerHTML="No servers available";
		}
		var runServerSelect=function(){
			s.selectServer(function(server){
				if(server!=null){ //at least 1 server is available
					I("loading").style.display="none"; //hide loading message
					//populate server list for manual selection
					var serverSelect = I("server");
					// Clear existing options except the first "Auto Selected"
					serverSelect.innerHTML = '<option value="">Auto Selected</option>';
					
					for(var i=0;i<SPEEDTEST_SERVERS.length;i++){
						if(SPEEDTEST_SERVERS[i].pingT==-1) continue;
						var option=document.createElement("option");
						option.value=i;
						option.textContent=SPEEDTEST_SERVERS[i].name;
						if(SPEEDTEST_SERVERS[i]===server) option.selected=true;
						serverSelect.appendChild(option);
					}
					
					// Initialize server info display
					updateServerInfo();
					//show test UI
					I("testWrapper").classList.remove("hidden");
					initUI();
				}else{ //no servers are available, the test cannot proceed
					noServersAvailable();
				}
			});
		}
		if(typeof SPEEDTEST_SERVERS === "string"){
			//need to fetch list of servers from specified URL
			s.loadServerList(SPEEDTEST_SERVERS,function(servers){
				if(servers==null){ //failed to load server list
					noServersAvailable();
				}else{ //server list loaded
					SPEEDTEST_SERVERS=servers;
					runServerSelect();
				}
			});
		}else{
			//hardcoded server list
			s.addTestPoints(SPEEDTEST_SERVERS);
			runServerSelect();
		}
	}
}

var meterBk=/Trident.*rv:(\d+\.\d+)/i.test(navigator.userAgent)?"#EAEAEA":"#E5E7EB";
var dlColor="#3B82F6",
	ulColor="#8B5CF6";

//CODE FOR ENHANCED SPEEDOMETER
var lastDrawnAmount = 0;
var animationId = null;

function drawMeter(c, targetAmount, bk, fg, animated = true){
	if(!c || !c.getContext) return;
	
	var ctx = c.getContext("2d");
	var dp = window.devicePixelRatio || 1;
	var cw = c.clientWidth * dp;
	var ch = c.clientHeight * dp;
	
	// Ensure canvas has dimensions
	if(cw === 0 || ch === 0) {
		cw = 320 * dp;
		ch = 320 * dp;
	}
	
	// Only resize canvas if dimensions changed
	if(c.width !== cw || c.height !== ch){
		c.width = cw;
		c.height = ch;
	}
	
	var centerX = cw / 2;
	var centerY = ch / 2;
	var radius = Math.min(cw, ch) * 0.38;
	var lineWidth = Math.max(6, Math.min(cw, ch) * 0.018);
	
	// Smooth animation
	if(animated && Math.abs(targetAmount - lastDrawnAmount) > 0.01) {
		if(animationId) cancelAnimationFrame(animationId);
		
		var startAmount = lastDrawnAmount;
		var startTime = performance.now();
		var duration = 300; // ms
		
		function animate(currentTime) {
			var elapsed = currentTime - startTime;
			var progress = Math.min(elapsed / duration, 1);
			
			// Easing function for smooth animation
			var easeProgress = 1 - Math.pow(1 - progress, 3);
			var currentAmount = startAmount + (targetAmount - startAmount) * easeProgress;
			
			drawSpeedometerFrame(ctx, currentAmount, bk, fg, centerX, centerY, radius, lineWidth, cw, ch);
			
			if(progress < 1) {
				animationId = requestAnimationFrame(animate);
			} else {
				lastDrawnAmount = targetAmount;
				animationId = null;
			}
		}
		
		animationId = requestAnimationFrame(animate);
	} else {
		drawSpeedometerFrame(ctx, targetAmount, bk, fg, centerX, centerY, radius, lineWidth, cw, ch);
		lastDrawnAmount = targetAmount;
	}
}

function drawSpeedometerFrame(ctx, amount, bk, fg, centerX, centerY, radius, lineWidth, cw, ch) {
	// Clear canvas efficiently
	ctx.clearRect(0, 0, cw, ch);
	
	// Enable anti-aliasing for smoother lines
	ctx.imageSmoothingEnabled = true;
	ctx.imageSmoothingQuality = 'high';
	
	var startAngle = 0.75 * Math.PI;
	var endAngle = 0.25 * Math.PI;
	var totalAngle = 1.5 * Math.PI;
	var currentAngle = startAngle + amount * totalAngle;
	
	// Background track with subtle gradient
	var bgGradient = ctx.createLinearGradient(centerX - radius, centerY - radius, centerX + radius, centerY + radius);
	bgGradient.addColorStop(0, bk);
	bgGradient.addColorStop(1, bk + '80'); // Add slight transparency
	
	ctx.beginPath();
	ctx.strokeStyle = bgGradient;
	ctx.lineWidth = lineWidth;
	ctx.lineCap = "round";
	ctx.arc(centerX, centerY, radius, startAngle, endAngle);
	ctx.stroke();
	
	// Progress arc with gradient
	if(amount > 0) {
		var progressGradient = ctx.createLinearGradient(centerX - radius, centerY - radius, centerX + radius, centerY + radius);
		progressGradient.addColorStop(0, fg);
		progressGradient.addColorStop(0.5, fg + 'E6'); // Slightly more opaque
		progressGradient.addColorStop(1, fg);
		
		ctx.beginPath();
		ctx.strokeStyle = progressGradient;
		ctx.lineWidth = lineWidth + 1;
		ctx.lineCap = "round";
		ctx.arc(centerX, centerY, radius, startAngle, currentAngle);
		ctx.stroke();
		
		// Add glow effect for progress
		ctx.shadowColor = fg;
		ctx.shadowBlur = 8;
		ctx.beginPath();
		ctx.strokeStyle = fg;
		ctx.lineWidth = lineWidth - 2;
		ctx.arc(centerX, centerY, radius, startAngle, currentAngle);
		ctx.stroke();
		ctx.shadowBlur = 0;
		
		// Progress indicator dot
		var dotX = centerX + radius * Math.cos(currentAngle);
		var dotY = centerY + radius * Math.sin(currentAngle);
		
		ctx.beginPath();
		ctx.fillStyle = fg;
		ctx.arc(dotX, dotY, lineWidth / 3, 0, 2 * Math.PI);
		ctx.fill();
		
		// Dot highlight
		ctx.beginPath();
		ctx.fillStyle = '#FFFFFF';
		ctx.arc(dotX, dotY, lineWidth / 6, 0, 2 * Math.PI);
		ctx.fill();
	}
	
	// Speed range markers
	drawSpeedMarkers(ctx, centerX, centerY, radius, lineWidth, startAngle, endAngle);
}

function drawSpeedMarkers(ctx, centerX, centerY, radius, lineWidth, startAngle, endAngle) {
	var markerRadius = radius + lineWidth / 2 + 4;
	var innerRadius = radius - lineWidth / 2 - 4;
	
	// Draw markers for speed ranges (0, 25, 50, 75, 100+ percentiles)
	for(var i = 0; i <= 4; i++) {
		var angle = startAngle + (i / 4) * 1.5 * Math.PI;
		var outerX = centerX + markerRadius * Math.cos(angle);
		var outerY = centerY + markerRadius * Math.sin(angle);
		var innerX = centerX + innerRadius * Math.cos(angle);
		var innerY = centerY + innerRadius * Math.sin(angle);
		
		ctx.beginPath();
		ctx.strokeStyle = '#94A3B8';
		ctx.lineWidth = 1;
		ctx.moveTo(outerX, outerY);
		ctx.lineTo(innerX, innerY);
		ctx.stroke();
	}
}
function mbpsToAmount(s){
	if(isNaN(s) || s < 0) {
		console.warn("Invalid speed value for mbpsToAmount:", s);
		return 0;
	}
	var result = 1-(1/(Math.pow(1.3,Math.sqrt(s))));
	console.log("mbpsToAmount - Input:", s, "Output:", result);
	return result;
}
function format(d){
    d=Number(d);
    if(d<10) return d.toFixed(2);
    if(d<100) return d.toFixed(1);
    return d.toFixed(0);
}

//UI CODE
var uiData=null;
function startStop(){
    if(s.getState()==3){
		//speed test is running, abort
		s.abort();
		data=null;
		I("startStopBtn").classList.remove("opacity-50");
		I("button-text").textContent="Start Test";
		I("server").disabled=false;
		initUI();
	}else{
		//test is not running, begin
		I("startStopBtn").classList.add("opacity-50");
		I("button-text").textContent="Stop Test";
		I("shareArea").style.display="none";
		I("server").disabled=true;
		s.onupdate=function(data){
            uiData=data;
		};
		s.onend=function(aborted){
            I("startStopBtn").classList.remove("opacity-50");
            I("button-text").textContent="Start Test";
            I("server").disabled=false;
            updateUI(true);
            if(!aborted){
                //if testId is present, show sharing panel, otherwise do nothing
                try{
                    var testId=uiData.testId;
                    if(testId!=null){
                        var shareURL=window.location.href.substring(0,window.location.href.lastIndexOf("/"))+"/results/?id="+testId;
                        I("resultsImg").src=shareURL;
                        I("resultsURL").value=shareURL;
                        I("testId").innerHTML=testId;
                        I("shareArea").style.display="";
                    }
                }catch(e){}
            }
		};
		s.start();
	}
}
//this function reads the data sent back by the test and updates the UI
function updateUI(forced){
	if(!forced&&s.getState()!=3) return;
	if(uiData==null) return;
	var status=uiData.testState;
	
	// Update IP address and related info
	var clientIpRaw = uiData.clientIp || "-";
	var ipAddress = "-";
	var ispName = "-";
	
	// Parse combined IP and ISP info if it contains a separator
	if(clientIpRaw && clientIpRaw !== "-") {
		if(clientIpRaw.includes(" - ")) {
			// Format: "192.168.1.1 - ISP Name"
			var parts = clientIpRaw.split(" - ");
			ipAddress = parts[0].trim();
			ispName = parts[1].trim();
		} else if(clientIpRaw.includes("-")) {
			// Format: "192.168.1.1-ISP Name" or "192.168.1.1 -ISP Name"
			var parts = clientIpRaw.split("-");
			ipAddress = parts[0].trim();
			ispName = parts[1] ? parts[1].trim() : "-";
		} else if(clientIpRaw.includes(" ") && !clientIpRaw.match(/^\d+\.\d+\.\d+\.\d+$/)) {
			// Format: "192.168.1.1 ISP Company Name"
			var parts = clientIpRaw.split(" ", 2);
			ipAddress = parts[0].trim();
			ispName = clientIpRaw.substring(parts[0].length).trim();
		} else {
			// Assume it's just the IP address
			ipAddress = clientIpRaw;
		}
		
		console.log("IP parsing - Raw:", clientIpRaw, "IP:", ipAddress, "ISP:", ispName);
	}
	
	I("ip").textContent = ipAddress;
	
	// Update ISP information with extracted ISP or fallback to other sources
	if(ispName && ispName !== "-") {
		I("isp").textContent = ispName;
	} else if(uiData.ispInfo) {
		I("isp").textContent = uiData.ispInfo.rawIspInfo || uiData.ispInfo.processedString || "-";
	} else if(uiData.clientIspInfo) {
		I("isp").textContent = uiData.clientIspInfo || "-";
	} else {
		// Try other possible ISP field names
		I("isp").textContent = uiData.ispOrganization || uiData.isp || "-";
	}
	
	// Update location information if available
	if(uiData.ispInfo && (uiData.ispInfo.country || uiData.ispInfo.region)) {
		var location = "";
		if(uiData.ispInfo.region) location += uiData.ispInfo.region;
		if(uiData.ispInfo.country) {
			if(location) location += ", ";
			location += uiData.ispInfo.country;
		}
		I("location").textContent = location || "-";
	} else if(uiData.clientLocation) {
		I("location").textContent = uiData.clientLocation || "-";
	} else {
		// Try other possible location field combinations
		var location = "";
		if(uiData.city) location += uiData.city;
		if(uiData.region || uiData.state) {
			if(location) location += ", ";
			location += (uiData.region || uiData.state);
		}
		if(uiData.country) {
			if(location) location += ", ";
			location += uiData.country;
		}
		I("location").textContent = location || "-";
	}
	
	// Update download speed
	var dlSpeed = (status==1&&uiData.dlStatus==0)?"...":format(uiData.dlStatus);
	I("dlText").textContent=dlSpeed;
	I("speed-value").textContent = (status==1) ? dlSpeed : (uiData.dlStatus ? format(uiData.dlStatus) : "0.00");
	I("speed-type").textContent = (status==1) ? "Download" : (status==3) ? "Upload" : (status==2) ? "Ping" : "Ready";
	
	// Update upload speed
	var ulSpeed = (status==3&&uiData.ulStatus==0)?"...":format(uiData.ulStatus);
	I("ulText").textContent=ulSpeed;
	if(status==3) {
		I("speed-value").textContent = ulSpeed;
	}
	
	// Update ping and jitter
	I("pingText").textContent=format(uiData.pingStatus);
	I("jitText").textContent=format(uiData.jitterStatus);
	
	
	// Draw main speedometer
	var currentSpeed = 0;
	var speedColor = dlColor;
	
	// Determine current speed and color based on test state
	if(status == 1) { // Download test - active
		// Use actual download speed value, not the formatted text
		currentSpeed = Number(uiData.dlStatus) || 0;
		speedColor = dlColor;
		console.log("Download - Status:", status, "Speed:", currentSpeed, "dlStatus:", uiData.dlStatus);
	} else if(status == 3) { // Upload test - active  
		currentSpeed = Number(uiData.ulStatus) || 0;
		speedColor = ulColor;
		console.log("Upload - Status:", status, "Speed:", currentSpeed, "ulStatus:", uiData.ulStatus);
	} else if(status == 2) { // Ping test - active
		currentSpeed = 0; // Don't show speed during ping
		speedColor = dlColor;
		console.log("Ping - Status:", status);
	} else {
		// Test not running or completed, show final download speed if available
		currentSpeed = Number(uiData.dlStatus) || 0;
		speedColor = dlColor;
		console.log("Idle/Complete - Status:", status, "Speed:", currentSpeed);
	}
	
	var speedometerCanvas = I("speedometer");
	if(speedometerCanvas) {
		var oscillation = (status >= 1 && status <= 3) ? oscillate() : 1;
		var adjustedSpeed = Math.max(0, currentSpeed * oscillation); // Ensure non-negative
		var speedAmount = mbpsToAmount(adjustedSpeed);
		
		// Additional debugging
		console.log("Drawing speedometer - Status:", status, "Raw Speed:", currentSpeed, "Adjusted:", adjustedSpeed, "Amount:", speedAmount, "Color:", speedColor);
		
		// Ensure we have valid values
		if(speedAmount >= 0 && speedAmount <= 1) {
			drawMeter(speedometerCanvas, speedAmount, meterBk, speedColor, true);
		} else {
			console.warn("Invalid speedAmount:", speedAmount, "using 0 instead");
			drawMeter(speedometerCanvas, 0, meterBk, speedColor, true);
		}
	}
}
function oscillate(){
	return 1+0.02*Math.sin(Date.now()/100);
}
//update the UI every frame
window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.msRequestAnimationFrame||(function(callback,element){setTimeout(callback,1000/60);});
function frame(){
	requestAnimationFrame(frame);
	updateUI();
}
frame(); //start frame loop

// Function to update server info display
function updateServerInfo() {
	var serverSelect = I("server");
	var selectedIndex = serverSelect.value;
	if(selectedIndex && SPEEDTEST_SERVERS[selectedIndex]) {
		var selectedServer = SPEEDTEST_SERVERS[selectedIndex];
		I("server-distance").textContent = selectedServer.distance || "-";
		I("server-sponsor").textContent = selectedServer.sponsor || "LibreSpeed";
	} else {
		I("server-distance").textContent = "-";
		I("server-sponsor").textContent = "LibreSpeed";
	}
}

// Dark Mode Script - initialize after DOM is loaded
function initThemeToggle() {
    const themeToggleBtn = document.getElementById('theme-toggle');
    const themeToggleDarkIcon = document.getElementById('theme-toggle-dark-icon');
    const themeToggleLightIcon = document.getElementById('theme-toggle-light-icon');

    if (!themeToggleBtn || !themeToggleDarkIcon || !themeToggleLightIcon) {
        return; // Elements not found, skip theme toggle setup
    }

    // Check if dark mode is enabled
    if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        themeToggleLightIcon.classList.remove('hidden');
        document.documentElement.classList.add('dark');
    } else {
        themeToggleDarkIcon.classList.remove('hidden');
    }

    themeToggleBtn.addEventListener('click', function() {
        // Toggle icons inside button
        themeToggleDarkIcon.classList.toggle('hidden');
        themeToggleLightIcon.classList.toggle('hidden');

        // Toggle dark mode
        var isDark = document.documentElement.classList.contains('dark');
        if (isDark) {
            document.documentElement.classList.remove('dark');
            localStorage.setItem('color-theme', 'light');
        } else {
            document.documentElement.classList.add('dark');
            localStorage.setItem('color-theme', 'dark');
        }
    });
}
//function to (re)initialize UI
function initUI(){
	// Reset animation state
	lastDrawnAmount = 0;
	if(animationId) {
		cancelAnimationFrame(animationId);
		animationId = null;
	}
	
	var speedometerCanvas = I("speedometer");
	if(speedometerCanvas) {
		// Force canvas to have visible dimensions and initialize without animation
		setTimeout(function() {
			drawMeter(speedometerCanvas, 0, meterBk, dlColor, false);
		}, 100);
	}
	I("dlText").textContent="0.00";
	I("ulText").textContent="0.00";
	I("pingText").textContent="0";
	I("jitText").textContent="0.0";
	I("ip").textContent="-";
	I("isp").textContent="-";
	I("location").textContent="-";
	I("speed-value").textContent="0.00";
	I("speed-type").textContent="Ready";
	// Reset button text
	I("button-text").textContent="Start Test";
}
</script>
</head>
<body class="h-full bg-gradient-to-br from-blue-50 to-indigo-100 dark:from-gray-900 dark:to-gray-800 transition-colors duration-300" onload="initServers()">
    <div class="min-h-full flex flex-col">
        <!-- Header -->
        <header class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center space-x-2">
                        <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-indigo-600 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                        </div>
                        <h1 class="text-xl font-bold text-gray-900 dark:text-white">LibreSpeed</h1>
                    </div>
                    
                    <!-- Dark mode toggle -->
                    <button id="theme-toggle" class="p-2 rounded-lg bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                        <svg id="theme-toggle-dark-icon" class="hidden w-5 h-5 text-gray-600 dark:text-gray-300" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
                        </svg>
                        <svg id="theme-toggle-light-icon" class="hidden w-5 h-5 text-gray-600 dark:text-gray-300" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </header>

        <!-- Loading Screen -->
        <div id="loading" class="visible flex-1 flex items-center justify-center">
            <div class="text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-4 border-blue-500 border-t-transparent mx-auto mb-4"></div>
                <p id="message" class="text-gray-600 dark:text-gray-300">Selecting a server...</p>
            </div>
        </div>

        <!-- Main Content -->
        <main id="testWrapper" class="hidden flex-1 flex items-center justify-center px-4 py-8">
            <div class="w-full max-w-4xl mx-auto">
                <!-- Speed Display -->
                <section class="text-center mb-8">
                    <div class="relative inline-block">
                        <!-- Speedometer Circle -->
                        <div class="relative w-64 h-64 sm:w-80 sm:h-80 mx-auto mb-6">
                            <canvas id="speedometer" class="absolute inset-0 w-full h-full"></canvas>
                            
                            <!-- Speed Value -->
                            <div class="absolute inset-0 flex flex-col items-center justify-center z-10">
                                <div id="speed-value" class="text-4xl sm:text-6xl font-bold text-gray-900 dark:text-white mb-2">0.00</div>
                                <div id="speed-unit" class="text-lg sm:text-xl text-gray-600 dark:text-gray-300 font-medium">Mbps</div>
                                <div id="speed-type" class="text-sm text-gray-500 dark:text-gray-400 mt-1">Ready</div>
                            </div>
                        </div>
                        
                        <!-- Test Button -->
                        <div id="startStopBtn" onclick="startStop()" class="group relative bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white font-semibold py-4 px-8 rounded-full shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200 focus:outline-none focus:ring-4 focus:ring-blue-300 dark:focus:ring-blue-800 cursor-pointer inline-flex items-center space-x-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1m4 0h1m-6 4h8m-2-14V3a2 2 0 00-2-2H9a2 2 0 00-2 2v1M7 7h10l4 4v6a2 2 0 01-2 2H5a2 2 0 01-2-2V11l4-4z"></path>
                            </svg>
                            <span id="button-text">Start Test</span>
                        </div>
                    </div>
                </section>

                <!-- Test Results Grid -->
                <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                    <!-- Download Speed -->
                    <div class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm rounded-xl p-6 shadow-sm hover:shadow-md transition-shadow">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-sm font-medium text-gray-600 dark:text-gray-300">Download</h3>
                            <svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                            </svg>
                        </div>
                        <div id="dlText" class="text-2xl font-bold text-gray-900 dark:text-white">0.00</div>
                        <div class="text-sm text-gray-500 dark:text-gray-400">Mbps</div>
                    </div>

                    <!-- Upload Speed -->
                    <div class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm rounded-xl p-6 shadow-sm hover:shadow-md transition-shadow">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-sm font-medium text-gray-600 dark:text-gray-300">Upload</h3>
                            <svg class="w-4 h-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                            </svg>
                        </div>
                        <div id="ulText" class="text-2xl font-bold text-gray-900 dark:text-white">0.00</div>
                        <div class="text-sm text-gray-500 dark:text-gray-400">Mbps</div>
                    </div>

                    <!-- Ping -->
                    <div class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm rounded-xl p-6 shadow-sm hover:shadow-md transition-shadow">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-sm font-medium text-gray-600 dark:text-gray-300">Ping</h3>
                            <svg class="w-4 h-4 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div id="pingText" class="text-2xl font-bold text-gray-900 dark:text-white">0</div>
                        <div class="text-sm text-gray-500 dark:text-gray-400">ms</div>
                    </div>

                    <!-- Jitter -->
                    <div class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm rounded-xl p-6 shadow-sm hover:shadow-md transition-shadow">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-sm font-medium text-gray-600 dark:text-gray-300">Jitter</h3>
                            <svg class="w-4 h-4 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                        </div>
                        <div id="jitText" class="text-2xl font-bold text-gray-900 dark:text-white">0.0</div>
                        <div class="text-sm text-gray-500 dark:text-gray-400">ms</div>
                    </div>
                </section>

                <!-- Connection Info -->
                <section class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                    <!-- IP Address & Location -->
                    <div class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm rounded-xl p-6 shadow-sm">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                            <svg class="w-5 h-5 mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                            Your Connection
                        </h3>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600 dark:text-gray-300">IP Address</span>
                                <span id="ip" class="font-mono text-gray-900 dark:text-white">-</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600 dark:text-gray-300">ISP</span>
                                <span id="isp" class="text-gray-900 dark:text-white">-</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600 dark:text-gray-300">Location</span>
                                <span id="location" class="text-gray-900 dark:text-white">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Server Info -->
                    <div class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm rounded-xl p-6 shadow-sm">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                            <svg class="w-5 h-5 mr-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01"></path>
                            </svg>
                            Test Server
                        </h3>
                        <div class="space-y-3">
                            <div id="serverArea" class="flex justify-between items-center">
                                <span class="text-gray-600 dark:text-gray-300">Server</span>
                                <select id="server" onchange="s.setSelectedServer(SPEEDTEST_SERVERS[this.value]); updateServerInfo()" class="bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded px-3 py-1 text-gray-900 dark:text-white text-sm min-w-0 flex-1 ml-4">
                                    <option value="">Auto Selected</option>
                                </select>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600 dark:text-gray-300">Distance</span>
                                <span id="server-distance" class="text-gray-900 dark:text-white">-</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600 dark:text-gray-300">Sponsor</span>
                                <span id="server-sponsor" class="text-gray-900 dark:text-white">LibreSpeed</span>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Share Results Area -->
                <div id="shareArea" style="display:none" class="mb-8">
                    <div class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm rounded-xl p-6 shadow-sm text-center">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Share Results</h3>
                        <p class="text-gray-600 dark:text-gray-300 mb-2">Test ID: <span id="testId" class="font-mono"></span></p>
                        <input type="text" value="" id="resultsURL" readonly="readonly" onclick="this.select();this.focus();this.select();document.execCommand('copy');alert('Link copied')" class="w-full p-2 mb-4 border border-gray-300 dark:border-gray-600 rounded bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white"/>
                        <img src="" id="resultsImg" class="mx-auto max-w-full" />
                    </div>
                </div>

            </div>
        </main>

        <!-- Footer -->
        <footer class="bg-white/50 dark:bg-gray-800/50 backdrop-blur-sm border-t border-gray-200 dark:border-gray-700">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
                <div class="flex flex-col sm:flex-row justify-between items-center text-sm text-gray-600 dark:text-gray-300">
                    <p>&copy; 2025 LibreSpeed. Open source speed test.</p>
                    <div class="flex space-x-4 mt-2 sm:mt-0">
                        <a href="#" class="hover:text-blue-500 transition-colors" onclick="I('privacyPolicy').style.display=''">Privacy</a>
                        <a href="https://github.com/librespeed/speedtest" class="hover:text-blue-500 transition-colors">GitHub</a>
                    </div>
                </div>
            </div>
        </footer>
    </div>
    <!-- Privacy Policy Modal -->
    <div id="privacyPolicy" style="display:none" class="fixed inset-0 z-50 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="fixed inset-0 bg-black opacity-50"></div>
            <div class="relative bg-white dark:bg-gray-800 rounded-lg max-w-2xl w-full max-h-screen overflow-y-auto p-6">
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">Privacy Policy</h2>
                <div class="text-gray-700 dark:text-gray-300 space-y-4">
                    <p>This HTML5 speed test server is configured with telemetry enabled.</p>
                    <h4 class="text-lg font-semibold text-gray-900 dark:text-white">What data we collect</h4>
                    <p>
                        At the end of the test, the following data is collected and stored:
                        <ul class="list-disc list-inside ml-4 space-y-1">
                            <li>Test ID</li>
                            <li>Time of testing</li>
                            <li>Test results (download and upload speed, ping and jitter)</li>
                            <li>IP address</li>
                            <li>ISP information</li>
                            <li>Approximate location (inferred from IP address, not GPS)</li>
                            <li>User agent and browser locale</li>
                            <li>Test log (contains no personal information)</li>
                        </ul>
                    </p>
                    <h4 class="text-lg font-semibold text-gray-900 dark:text-white">How we use the data</h4>
                    <p>
                        Data collected through this service is used to:
                        <ul class="list-disc list-inside ml-4 space-y-1">
                            <li>Allow sharing of test results (sharable image for forums, etc.)</li>
                            <li>To improve the service offered to you (for instance, to detect problems on our side)</li>
                        </ul>
                        No personal information is disclosed to third parties.
                    </p>
                    <h4 class="text-lg font-semibold text-gray-900 dark:text-white">Your consent</h4>
                    <p>
                        By starting the test, you consent to the terms of this privacy policy.
                    </p>
                    <h4 class="text-lg font-semibold text-gray-900 dark:text-white">Data removal</h4>
                    <p>
                        If you want to have your information deleted, you need to provide either the ID of the test or your IP address. This is the only way to identify your data, without this information we won't be able to comply with your request.<br/><br/>
                        Contact this email address for all deletion requests: <a href="mailto:PUT@YOUR_EMAIL.HERE" class="text-blue-500 hover:text-blue-600">TO BE FILLED BY DEVELOPER</a>.
                    </p>
                </div>
                <div class="mt-6 text-center">
                    <button onclick="I('privacyPolicy').style.display='none'" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg transition-colors">Close</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>