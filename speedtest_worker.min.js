function clearRequests(){if(xhr){for(var i=0;i<xhr.length;i++){if(useFetchAPI)try{xhr[i].cancelRequested=!0}catch(e){}try{xhr[i].onprogress=null,xhr[i].onload=null,xhr[i].onerror=null}catch(e){}try{xhr[i].upload.onprogress=null,xhr[i].upload.onload=null,xhr[i].upload.onerror=null}catch(e){}try{xhr[i].abort()}catch(e){}try{delete xhr[i]}catch(e){}}xhr=null}}function getIp(done){(xhr=new XMLHttpRequest).onload=function(){clientIp=xhr.responseText,done()},xhr.onerror=function(){done()},xhr.open("GET",settings.url_getIp+"?r="+Math.random(),!0),xhr.send()}function getServer(done){if(!settings.enable_multiPots)return done();var pots={},times=[],ping="";(xhr=new XMLHttpRequest).onload=function(){for(var tmp=JSON.parse(xhr.responseText),routes=tmp.routes,pointsOfTest=tmp.result,i=0;i<pointsOfTest.length;i++){try{!function(url){var start=(new Date).getTime();(xhr=new XMLHttpRequest).onload=function(){var end=(new Date).getTime();ping=(ping=end-start).toFixed(2)},xhr.onerror=function(){ping="Fail"},xhr.open("GET",url,!1),xhr.send()}(pointsOfTest[i])}catch(e){ping="Fail"}"Fail"!==ping&&(pots[ping]=pointsOfTest[i],times.push(ping))}times.sort(function(a,b){return a-b}),pot=pots[times[0]],settings.url_ping=pot,settings.url_dl=pot+routes.download,settings.url_ul=pot+routes.upload,console.log("Available servers: "+JSON.stringify(pots)),console.log("Best point of test: "+pot),done()},xhr.onerror=function(){done()},xhr.open("POST",settings.url_getPointsOfTest,!0),xhr.setRequestHeader("Content-Type","application/json"),xhr.setRequestHeader("Accept","application/json"),xhr.send(JSON.stringify({data:{}}))}function dlTest(done){if(!dlCalled){dlCalled=!0;var totLoaded=0,startT=(new Date).getTime(),failed=!1;xhr=[];for(var testStream=function(i,delay){setTimeout(function(){if(1===testStatus)if(useFetchAPI){queryString=settings.url_dl+settings.garbagePhp_chunkSize+"?r="+Math.random();xhr[i]=fetch(queryString).then(function(response){var reader=response.body.getReader(),consume=function(){return reader.read().then(function(result){return result.done?testStream(i):(totLoaded+=result.value.length,xhr[i].cancelRequested&&reader.cancel()),consume()})};return consume()})}else{var prevLoaded=0,x=new XMLHttpRequest;xhr[i]=x,xhr[i].onprogress=function(event){if(1!==testStatus)try{x.abort()}catch(e){}var loadDiff=event.loaded<=0?0:event.loaded-prevLoaded;isNaN(loadDiff)||!isFinite(loadDiff)||loadDiff<0||(totLoaded+=loadDiff,prevLoaded=event.loaded)},xhr[i].onload=function(){try{xhr[i].abort()}catch(e){}testStream(i,0)},xhr[i].onerror=function(){failed=!0;try{xhr[i].abort()}catch(e){}delete xhr[i]};try{settings.xhr_dlUseBlob?xhr[i].responseType="blob":xhr[i].responseType="arraybuffer"}catch(e){}var queryString=settings.url_dl+settings.garbagePhp_chunkSize+"?r="+Math.random();xhr[i].open("GET",queryString,!0),xhr[i].send()}},1+delay)},i=0;i<settings.xhr_dlMultistream;i++)testStream(i,100*i);interval=setInterval(function(){var t=(new Date).getTime()-startT;t<200||(dlStatus=(8*(totLoaded/(t/1e3))/925e3).toFixed(2),(t/1e3>settings.time_dl||failed)&&((failed||isNaN(dlStatus))&&(dlStatus="Fail"),clearRequests(),clearInterval(interval),done()))},200)}}function ulTest(done){if(!ulCalled){ulCalled=!0;var totLoaded=0,startT=(new Date).getTime(),failed=!1;xhr=[];for(var testStream=function(i,delay){setTimeout(function(){if(3===testStatus){var prevLoaded=0,x=new XMLHttpRequest;xhr[i]=x;var ie11workaround;try{xhr[i].upload.onprogress,ie11workaround=!1}catch(e){ie11workaround=!0}ie11workaround?(xhr[i].onload=function(){totLoaded+=262144,testStream(i,0)},xhr[i].onerror=function(){failed=!0;try{xhr[i].abort()}catch(e){}delete xhr[i]},xhr[i].open("POST",settings.url_ul+"?r="+Math.random(),!0),xhr[i].setRequestHeader("Content-Encoding","identity"),xhr[i].send(reqsmall)):(xhr[i].upload.onprogress=function(event){if(3!==testStatus)try{x.abort()}catch(e){}var loadDiff=event.loaded<=0?0:event.loaded-prevLoaded;isNaN(loadDiff)||!isFinite(loadDiff)||loadDiff<0||(totLoaded+=loadDiff,prevLoaded=event.loaded)},xhr[i].upload.onload=function(){testStream(i,0)},xhr[i].upload.onerror=function(){failed=!0;try{xhr[i].abort()}catch(e){}delete xhr[i]},xhr[i].open("POST",settings.url_ul+"?r="+Math.random(),!0),xhr[i].setRequestHeader("Content-Encoding","identity"),xhr[i].send(req))}},1)},i=0;i<settings.xhr_ulMultistream;i++)testStream(i,100*i);interval=setInterval(function(){var t=(new Date).getTime()-startT;t<200||(ulStatus=(8*(totLoaded/(t/1e3))/925e3).toFixed(2),(t/1e3>settings.time_ul||failed)&&((failed||isNaN(ulStatus))&&(ulStatus="Fail"),clearRequests(),clearInterval(interval),done()))},200)}}function pingTest(done){if(!ptCalled){ptCalled=!0;var prevT=null,ping=0,jitter=0,i=0,prevInstspd=0;xhr=[];var doPing=function(){prevT=(new Date).getTime(),xhr[0]=new XMLHttpRequest,xhr[0].onload=function(){if(0===i)prevT=(new Date).getTime();else{var instspd=((new Date).getTime()-prevT)/2,instjitter=Math.abs(instspd-prevInstspd);1===i?ping=instspd:(ping=.9*ping+.1*instspd,jitter=instjitter>jitter?.2*jitter+.8*instjitter:.9*jitter+.1*instjitter),prevInstspd=instspd}pingStatus=ping.toFixed(2),jitterStatus=jitter.toFixed(2),++i<settings.count_ping?doPing():done()},xhr[0].onerror=function(){packetLoss+=1},xhr[0].open("GET",settings.url_ping+"?r="+Math.random(),!0),xhr[0].send()};doPing()}}function ispInfo(done){try{(xhr=new XMLHttpRequest).onload=function(){var ispInfo=JSON.parse(xhr.responseText);ispInfo.hasOwnProperty("ip")&&(clientIp=ispInfo.ip),ispInfo.hasOwnProperty("country")&&(country=ispInfo.country),ispInfo.hasOwnProperty("region")&&(region=ispInfo.region),ispInfo.hasOwnProperty("org")&&(isp=ispInfo.org),done()},xhr.onerror=function(){done()},xhr.open("GET",settings.url_ispInfo,!0),xhr.setRequestHeader("Accept","application/json"),xhr.send()}catch(e){console.log(e.message)}}function saveResult(result){4===testStatus&&((xhr=new XMLHttpRequest).onload=function(){console.log(xhr.responseText)},xhr.onerror=function(){},xhr.open("POST",settings.url_saveResult,!0),xhr.setRequestHeader("Content-Type","application/json"),xhr.setRequestHeader("Accept","application/json"),xhr.send(JSON.stringify({data:result})))}var testStatus=0,dlStatus="",ulStatus="",pingStatus="",jitterStatus="",clientIp="",pot="",packetLoss=0,country="",region="",isp="",settings={time_ul:15,time_dl:15,count_ping:35,url_dl:"/download/",url_ul:"/upload",url_ping:"/ping",url_getIp:"/ip",url_getPointsOfTest:"/pots",url_saveResult:"/save",url_ispInfo:"http://ipinfo.io",xhr_dlMultistream:10,xhr_ulMultistream:3,xhr_dlUseBlob:!1,garbagePhp_chunkSize:20,enable_quirks:!0,enable_multiPots:!1,allow_fetchAPI:!1,force_fetchAPI:!1},xhr=null,interval=null,useFetchAPI=!1;this.addEventListener("message",function(e){var params=e.data.split(" "),useragent="";try{useragent=navigator.userAgent}catch(e){console.log(e.message)}if("status"===params[0]&&(postMessage(testStatus+";"+dlStatus+";"+ulStatus+";"+pingStatus+";"+clientIp+";"+jitterStatus+";"+pot+";"+packetLoss+";"+country+";"+region+";"+isp+";"+useragent),saveResult({download:dlStatus,upload:ulStatus,ping:pingStatus,jitter:jitterStatus,packetloss:packetLoss,pot:pot,useragent:useragent,country:country,region:region,isp:isp})),"start"===params[0]&&0===testStatus){testStatus=1;try{var s=JSON.parse(e.data.substring(5));if("undefined"!=typeof s.url_dl&&(settings.url_dl=s.url_dl),"undefined"!=typeof s.url_ul&&(settings.url_ul=s.url_ul),"undefined"!=typeof s.url_ping&&(settings.url_ping=s.url_ping),"undefined"!=typeof s.url_getIp&&(settings.url_getIp=s.url_getIp),"undefined"!=typeof s.url_getPointsOfTest&&(settings.url_getPointsOfTest=s.url_getPointsOfTest),"undefined"!=typeof s.url_saveResult&&(settings.url_saveResult=s.url_saveResult),"undefined"!=typeof s.time_dl&&(settings.time_dl=s.time_dl),"undefined"!=typeof s.time_ul&&(settings.time_ul=s.time_ul),"undefined"!=typeof s.enable_quirks&&(settings.enable_quirks=s.enable_quirks),"undefined"!=typeof s.enable_multiPots&&(settings.enable_multiPots=s.enable_multiPots),"undefined"!=typeof s.allow_fetchAPI&&(settings.allow_fetchAPI=s.allow_fetchAPI),settings.enable_quirks){var ua=navigator.userAgent;/Firefox.(\d+\.\d+)/i.test(ua)&&(settings.xhr_ulMultistream=1),/Edge.(\d+\.\d+)/i.test(ua)&&(settings.xhr_dlMultistream=3),/Safari.(\d+)/i.test(ua)&&!/Chrome.(\d+)/i.test(ua)&&(settings.xhr_ulMultistream=10,settings.garbagePhp_chunkSize=5),/Chrome.(\d+)/i.test(ua)&&self.fetch&&(settings.allow_fetchAPI&&(useFetchAPI=!0),settings.xhr_dlMultistream=5)}"undefined"!=typeof s.count_ping&&(settings.count_ping=s.count_ping),"undefined"!=typeof s.xhr_dlMultistream&&(settings.xhr_dlMultistream=s.xhr_dlMultistream),"undefined"!=typeof s.xhr_ulMultistream&&(settings.xhr_ulMultistream=s.xhr_ulMultistream),"undefined"!=typeof s.xhr_dlUseBlob&&(settings.xhr_dlUseBlob=s.xhr_dlUseBlob),"undefined"!=typeof s.garbagePhp_chunkSize&&(settings.garbagePhp_chunkSize=s.garbagePhp_chunkSize),"undefined"!=typeof s.force_fetchAPI&&(settings.force_fetchAPI=s.force_fetchAPI),settings.allow_fetchAPI&&settings.force_fetchAPI&&self.fetch&&(useFetchAPI=!0)}catch(e){}console.log(settings),console.log("Fetch API: "+useFetchAPI),getServer(function(){ispInfo(function(){dlTest(function(){testStatus=2,pingTest(function(){testStatus=3,ulTest(function(){testStatus=4})})})})})}"abort"===params[0]&&(clearRequests(),interval&&clearInterval(interval),testStatus=5,dlStatus="",ulStatus="",pingStatus="",jitterStatus="",pot="",packetLoss=0,country="",region="",isp="")});var dlCalled=!1,r=new ArrayBuffer(1048576);try{r=new Float32Array(r);for(var i=0;i<r.length;i++)r[i]=Math.random()}catch(e){}for(var req=[],reqsmall=[],i=0;i<20;i++)req.push(r);req=new Blob(req),r=new ArrayBuffer(262144);try{r=new Float32Array(r);for(var i=0;i<r.length;i++)r[i]=Math.random()}catch(e){}reqsmall.push(r),reqsmall=new Blob(reqsmall);var ulCalled=!1,ptCalled=!1;